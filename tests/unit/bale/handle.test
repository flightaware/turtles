## \file handle.test

package require tcltest
namespace import ::tcltest::*

set testDirectory [file join [file dirname [file normalize [info script]]]] 
source ../kmm.tcl
source ../bale/handle.tcl
namespace import ::turtles::bale::handle::*

set PROCS_NONE [dict create]
set PROCS_0_BLANK [dict create 0 [dict create]]
set PROCS_0_NOOP [dict create 0 [init_proc_node 0 {::noop}]]
set PROCS_0_NOOP_NO_AWAITING [dict remove $PROCS_0_NOOP 0 awaiting]


set CMDS_NONE [dict create]
set CMDS_FIND_MOE_0_NOOP [dict create {test_moe} [dict create 0 [list 0]]]

proc test_handler_return {cmd cmdArgs procsIn {procsOut {}} {cmdsExpected {}}} {
	set ::turtles::kmm::machines 1
	test [subst {{$cmd}_return}] [subst {$cmd $cmdArgs}] -body {
		set cmdsActual [$cmd procsIn $cmdArgs]
		return $cmdsActual
	} -result $cmdsExpected
}

# Testing add_proc
test_handler_return add_proc [list] [dict create] [dict create]

# Testing add_call
test_handler_return add_call [list] [dict create] [dict create]

# Testing find_moe
test_handler_return find_moe [list] $PROCS_NONE $PROCS_NONE $CMDS_NONE
test_handler_return find_moe [list] $PROCS_0_BLANK $PROCS_0_BLANK $CMDS_NONE
test_handler_return find_moe [list] $PROCS_0_NOOP $PROCS_0_NOOP $CMDS_NONE
test_handler_return find_moe [list 0] $PROCS_NONE $PROCS_NONE $CMDS_NONE
test_handler_return find_moe [list 0] $PROCS_0_BLANK $PROCS_0_BLANK $CMDS_NONE
test_handler_return find_moe [list 0] $PROCS_0_NOOP $PROCS_0_NOOP $CMDS_FIND_MOE_0_NOOP
# Degenerate cases to illustrate field requirements.
test_handler_return find_moe [list 0] [dict remove $PROCS_0_NOOP 0 awaiting] [dict remove $PROCS_0_NOOP 0 awaiting] $CMDS_NONE
test_handler_return find_moe [list 0] [dict remove $PROCS_0_NOOP 0 children] [dict remove $PROCS_0_NOOP 0 children] $CMDS_NONE

# Testing test_moe
test_handler_return test_moe [list] [dict create] [dict create] [dict create]
test_handler_return test_moe [list 0 1] [dict create] [dict create] [dict create]

# Testing req_root
test_handler_return req_root [list] [dict create] [dict create] [dict create]
test_handler_return req_root [list 0 1] [dict create] [dict create] [dict create]

# Testing rsp_root
test_handler_return rsp_root [list] [dict create] [dict create] [dict create]
test_handler_return rsp_root [list 0 1] [dict create] [dict create] [dict create]

# Testing found_moe
test_handler_return found_moe [list] [dict create] [dict create] [dict create]
test_handler_return found_moe [list 0 1] [dict create] [dict create] [dict create]


cleanupTests
