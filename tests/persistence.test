## \file persistence.test

package require tcltest
package require Thread
namespace import ::tcltest::*

# Module under test
source ../persistence.tcl

proc with_persistence_test {finalDB {commitMode staged} {intervalMillis 1000} {testBody {return 1}} {testResult 1}} {
	test with_persistence [subst {with_persistence $finalDB $commitMode $intervalMillis}] -setup {
		::turtles::persistence::start $finalDB $commitMode $intervalMillis
		if { $commitMode == "staged" && ![ thread::exists $::turtles::persistence::recorder ] } {
			error "Persistence mechanism is not running!"
		}
	} -body { [eval $testBody]
	} -cleanup {
		::turtles::persistence::stop
		if { $commitMode == "staged" && [ thread::exists $::turtles::persistence::recorder ] } {
			error "Persistence mechanism is still running!"
		}
	} -result $testResult
}

with_persistence_test ./finalDB
with_persistence_test ./finalDB direct
