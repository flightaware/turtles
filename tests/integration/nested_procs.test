#!/usr/bin/env tclsh

package require tcltest
package require turtles::test::integration::mt
package require turtles::test::integration::ev
package require turtles::test::integration::postmortem
namespace import ::tcltest::*

set defs {

}

namespace import turtles::test::integration::mt::*

set ab_staged_test {
	proc ::a {} { return [b] }
	proc ::b {} { return 0 }

	b
	a
	after 200
	# NB: This update is crucial for the ev tests.
	# It should be harmless for the mt tests.
	update
	test_caller_callee_count {stage1} {} {::b} 1
	test_caller_callee_count {stage1} {} {::a} 1
	test_caller_callee_count {stage1} {::a} {::b} 1
	return 1
}

set ab_direct_test {
	proc ::a {} { return [b] }
	proc ::b {} { return 0 }

	b
	a
	test_caller_callee_count {stage0} {} {::b} 1
	test_caller_callee_count {stage0} {} {::a} 1
	test_caller_callee_count {stage0} {::a} {::b} 1
	return 1
}

set post_mortem {
	::turtles::test::integration::postmortem::test_caller_callee_counts [ list
																		  {} {::b} 1
																		  {} {::a} 1
																		  {::a} {::b} 1 ]
}

with_turtles macOrUnix "Nested proc trace (mt) " staged 100 [subst {$ab_staged_test}] [subst {$post_mortem}]
with_turtles macOrUnix "Nested proc trace (mt) " direct 100 [subst {$ab_direct_test}] [subst {$post_mortem}]

namespace forget turtles::test::integration::mt::*
namespace import turtles::test::integration::ev::*

with_turtles macOrUnix "Nested proc trace (ev) " staged 100 [subst {$ab_staged_test}] [subst {$post_mortem}]
with_turtles macOrUnix "Nested proc trace (ev) " direct 100 [subst {$ab_direct_test}] [subst {$post_mortem}]


cleanupTests
